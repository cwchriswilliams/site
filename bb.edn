;; See https://book.babashka.org/#tasks
{:min-bb-version "0.6.2"
 :paths ["bb"]
 :deps {io.github.lispyclouds/bblgum {:git/sha "7ebae0e2231899fe2a6ad44bc9ef5fca64099fcd"}}
 :tasks
 {:requires (juxt.tasks
             juxt.installer-tree
             [clojure.core.async :as async])

  reset {:doc "Factory reset"
         :task (juxt.tasks/reset)}

  bootstrap {:doc "Bootstrap system"
             :task (juxt.tasks/bootstrap
                    {:auth-base-uri "https://auth.site.test"})}

  ls {:task (juxt.tasks/ls)}
  ls-type {:task (juxt.tasks/ls-type (first *command-line-args*))}
  users {:task (juxt.tasks/ls-type "user")}
  access-tokens {:task (juxt.tasks/ls-type "access-token")}

  openid {:task (juxt.tasks/openid
                 {:auth-base-uri "https://auth.site.test"})}

  system-api {:task (juxt.tasks/system-api
                     {:auth-base-uri "https://auth.site.test"
                      :data-base-uri "https://data.site.test"})}

  auth-server {:task (juxt.tasks/auth-server
                      {:auth-base-uri "https://auth.site.test"
                       :kid "testkp"})}

  add-user {:task (juxt.tasks/add-user
                   {:auth-base-uri "https://auth.site.test"
                    :data-base-uri "https://data.site.test"
                    :iss "https://juxt.eu.auth0.com"})}

  grant-role {:task (juxt.tasks/grant-role
                     {:auth-base-uri "https://auth.site.test"})}

  register-application {:task (juxt.tasks/register-application
                               {:auth-base-uri "https://auth.site.test"})}

  reinstall-openid (juxt.tasks/reinstall
                    {:auth-base-uri "https://auth.site.test"
                     :resource "https://auth.site.test/operations/openid/exchange-code-for-id-token"})

  full-deploy
  {:task
   (try
     (juxt.tasks/reset)
     (juxt.tasks/bootstrap {:auth-base-uri "https://auth.site.test"})
     (juxt.tasks/openid
      {:auth-base-uri "https://auth.site.test"
       :iss "https://juxt.eu.auth0.com"
       :client-id "d8X0TfEIcTl5oaltA4oy9ToEPdn5nFUK"
       :client-secret "gvk-mNdDmyaFsJwN_xVKHPH4pfrInYqJE1r8lRrn0gmoKI4us0Q5Eb7ULdruYZjD"})

     (juxt.tasks/system-api
      {:auth-base-uri "https://auth.site.test"
       :data-base-uri "https://data.site.test"})

     (juxt.tasks/auth-server
      {:auth-base-uri "https://auth.site.test"
       :kid "testkp"})

     (juxt.tasks/add-user
      {:auth-base-uri "https://auth.site.test"
       :data-base-uri "https://data.site.test"
       :username "mal"
       :fullname "Malcolm Sparks"
       :iss "https://juxt.eu.auth0.com"
       :nickname "malcolmsparks"})

     (juxt.tasks/register-application
      {:auth-base-uri "https://auth.site.test"
       :client-id "swagger-ui"
       :origin "https://swagger-ui.site.test"
       :resource-server "https://data.site.test"
       :redirect-uri "https://swagger-ui.site.test/oauth2-redirect.html"})

     (juxt.tasks/register-application
      {:auth-base-uri "https://auth.site.test"
       :client-id "surveyor"
       :origin "https://surveyor.site.test"
       :resource-server "https://data.site.test"
       :redirect-uri "https://surveyor.site.test/index.html"})

     (juxt.tasks/grant-role
      {:auth-base-uri "https://auth.site.test"
       :data-base-uri "https://data.site.test"
       :username "mal"
       :rolename "SystemReadonly"})

     (catch clojure.lang.ExceptionInfo e
       (System/exit 1)))}

  installer-tree {:task (juxt.installer-tree/installer-tree)}

  }}
